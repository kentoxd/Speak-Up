<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Practice History</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()">Close</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-list>
    <!-- The *ngFor defines both "session" and "i" -->
    <ng-container *ngFor="let session of sessions; let i = index">
      <ion-item
        button
        (click)="toggleExpand(i)"
        [color]="getAccuracyColor(session.analysis?.overallAccuracy || session.accuracy)"
      >
        <ion-label>
          <h2>{{ formatDate(session.timestamp) }}</h2>
          <p>
            {{ getPracticeTypeLabel(session.practiceType) }} •
            Accuracy:
            {{ session.analysis?.overallAccuracy || session.accuracy | number:'1.0-0' }}%
          </p>
        </ion-label>
      </ion-item>

      <!-- Expanded details (inside same ngFor scope!) -->
      <div *ngIf="expandedIndex === i" class="session-details ion-padding">
        <p><strong>Transcript:</strong> {{ session.transcript }}</p>
        <p><strong>Word Accuracy:</strong> {{ session.analysis?.wordAccuracy | number:'1.0-0' }}%</p>
        <p><strong>Punctuation Accuracy:</strong> {{ session.analysis?.punctuationAccuracy | number:'1.0-0' }}%</p>
        <p><strong>Overall Accuracy:</strong> {{ session.analysis?.overallAccuracy || session.accuracy | number:'1.0-0' }}%</p>
        <p><strong>Confidence:</strong> {{ session.confidence | percent:'1.0-0' }}</p>

        <div *ngIf="session.analysis?.fillerAnalysis">
          <h3>Filler Words</h3>
          <ul>
            <li *ngFor="let filler of session.analysis.fillerAnalysis.words">
              {{ filler.word }} — {{ filler.count }} times
            </li>
          </ul>
        </div>

        <div *ngIf="session.analysis?.clarityAnalysis">
          <h3>Clarity Feedback</h3>
          <ul>
            <li *ngFor="let feedback of session.analysis.clarityAnalysis.feedbackArray">
              {{ feedback }}
            </li>
          </ul>
        </div>
      </div>
    </ng-container>
  </ion-list>
</ion-content>
