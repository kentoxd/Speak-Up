<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Practice</ion-title>
    <ion-buttons slot="end">

    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  
  <div class="practice-container">

    <!-- Structured Practice Selection -->
    <div *ngIf="!isPracticing" class="structured-practice-selection">
      
      <!-- Header with Info Button -->
      <div class="intro-section">
        <div class="header-with-info">
          <h2>Structured Practice</h2>
          <ion-button 
            class="info-button"
            fill="clear" 
            color="primary"
            (click)="toggleInstructions()">
            <ion-icon 
              slot="icon-only" 
              [name]="showInstructions ? 'chevron-up-circle' : 'information-circle'">
            </ion-icon>
          </ion-button>
        </div>
        <p>Select practice type and difficulty to get targeted speaking exercises with personalized feedback.</p>
        
        <!-- Instructions Dropdown -->
        <div class="instructions-dropdown" *ngIf="showInstructions">
          <div class="instructions-container">
            <div class="instructions-header">
              <h3>
                <ion-icon name="bulb"></ion-icon>
                How to Use Structured Practice
              </h3>
            </div>
            <div class="instructions-body">
              <ol>
                <li><strong>Choose Mode:</strong> Select between preset exercises or create your own custom text</li>
                <li><strong>Set Parameters:</strong> For presets, pick a practice type and difficulty level. For custom, enter your own text (minimum 10 characters)</li>
                <li><strong>Review Preview:</strong> Click "SET PRACTICE" or "SET AS PRACTICE TEXT" to preview your selection</li>
                <li><strong>Start Practice:</strong> Click "START PRACTICE" when you're ready to begin</li>
                <li><strong>Record Speech:</strong> Read the target text aloud and record your speech</li>
                <li><strong>Get Feedback:</strong> Click "FEEDBACK" to see detailed analysis of your performance including accuracy, clarity, and speaking patterns</li>
              </ol>
            </div>
          </div>
        </div>
      </div>

      <!-- Toggle between preset and custom -->
      <div class="practice-mode-selector">
        <ion-segment 
          [value]="useCustomText ? 'custom' : 'preset'" 
          (ionChange)="useCustomText = $event.detail.value === 'custom'; loadStructuredPractice(); isPracticeReady = false;">
          <ion-segment-button value="preset">
            <ion-label>Preset Exercises</ion-label>
          </ion-segment-button>
          <ion-segment-button value="custom">
            <ion-label>Custom Text</ion-label>
          </ion-segment-button>
        </ion-segment>
      </div>

      <!-- Preset Practice Section -->
      <div *ngIf="!useCustomText">
        <!-- Practice Type Selector -->
        <div class="selector-section">
          <ion-item>
            <ion-select 
              label="Select Practice Type"
              [value]="selectedPracticeType" 
              (ionChange)="onPracticeTypeChange($event); isPracticeReady = false;"
              interface="popover">
              <ion-select-option 
                *ngFor="let type of practiceTypes" 
                [value]="type.value">
                {{ type.label }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Difficulty Selector -->
          <ion-item>
            <ion-select 
              label="Select Difficulty"
              [value]="selectedDifficulty" 
              (ionChange)="onDifficultyChange($event); isPracticeReady = false;"
              interface="popover">
              <ion-select-option 
                *ngFor="let level of difficultyLevels" 
                [value]="level.value">
                {{ level.label }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- SET Button for Preset -->
          <ion-button 
            expand="block" 
            fill="solid" 
            color="primary"
            size="large"
            (click)="setPracticeReady()"
            class="set-button">
            <ion-icon name="checkmark-circle" slot="start"></ion-icon>
            SET PRACTICE
          </ion-button>
        </div>

        <!-- Current Practice Preview - Now shows only after SET button is clicked -->
        <ion-card class="practice-preview" *ngIf="currentStructuredPractice && isPracticeReady">
          <ion-card-header>
            <ion-card-title>{{ currentStructuredPractice.title }}</ion-card-title>
            <ion-card-subtitle>{{ currentStructuredPractice.description }}</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <div class="practice-meta">
              <ion-chip [color]="selectedDifficulty === 'beginner' ? 'success' : selectedDifficulty === 'intermediate' ? 'warning' : 'danger'" outline>
                {{ selectedDifficulty | titlecase }}
              </ion-chip>
            </div>
            
            <ion-button 
              expand="block" 
              fill="solid" 
              color="success"
              size="large"
              (click)="startStructuredPractice()">
              <ion-icon name="play" slot="start"></ion-icon>
              START PRACTICE
            </ion-button>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Custom Text Section -->
      <div *ngIf="useCustomText">
        <ion-card class="custom-text-card">
          <ion-card-header>
            <ion-card-title>Create Custom Practice Text</ion-card-title>
            <ion-card-subtitle>Enter the text you want to practice speaking</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            
            <!-- Custom Text Form -->
            <label class="custom-textarea-label">Enter your practice text</label>
            <ion-item class="custom-textarea-item">
              <ion-textarea 
                placeholder="Type or paste text here... (minimum 10 characters)"
                [(ngModel)]="customTargetText"
                rows="6"
                maxlength="1000"
                class="custom-input-field">
              </ion-textarea>
            </ion-item>

            <div class="text-count">
              <small>{{ customTargetText.length }}/1000 characters</small>
            </div>

            <ion-button 
              expand="block" 
              fill="solid" 
              color="primary"
              size="large"
              [disabled]="customTargetText.trim().length < 10"
              (click)="setupCustomText()">
              <ion-icon name="checkmark-circle" slot="start"></ion-icon>
              SET AS PRACTICE TEXT
            </ion-button>
          </ion-card-content>
        </ion-card>

        <!-- Custom Practice Preview - Shows after SET AS PRACTICE TEXT is clicked -->
        <ion-card class="practice-preview" *ngIf="useCustomText && currentStructuredPractice?.targetText && isPracticeReady">
          <ion-card-header>
            <ion-card-title>{{ currentStructuredPractice?.title }}</ion-card-title>
            <ion-card-subtitle>{{ currentStructuredPractice?.description }}</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <div class="practice-meta">
              <ion-chip color="primary" outline>
                Custom Text
              </ion-chip>
            </div>
            
            <div class="custom-preview-text">
              {{ currentStructuredPractice?.targetText }}
            </div>
            
            <ion-button 
              expand="block" 
              fill="solid" 
              color="success"
              size="large"
              (click)="startStructuredPractice()">
              <ion-icon name="play" slot="start"></ion-icon>
              START PRACTICE
            </ion-button>
          </ion-card-content>
        </ion-card>
      </div>

      
      <!-- Practice History Summary -->
      <ion-card class="history-summary" *ngIf="practiceHistory.length > 0">
        <ion-card-header>
          <ion-card-title>Recent Activity</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="history-stats">
            <div class="stat">
              <span class="stat-number">{{ practiceHistory.length }}</span>
              <span class="stat-label"> Sessions</span>
            </div>
            <div class="stat">
              <span class="stat-number">{{ getTotalPracticeTime() }}</span>
              <span class="stat-label"></span>
            </div>
          </div>
          <ion-button fill="clear" (click)="viewHistoryWithFeedback()">
            View All History
            <ion-icon name="chevron-forward" slot="end"></ion-icon>
          </ion-button>
        </ion-card-content>
      </ion-card>
    </div>
  
    <!-- Structured Practice Session -->
    <div *ngIf="isPracticing" class="structured-practice-session">
      
      <!-- Session Header -->
      <div class="session-header">
        <h2>{{ currentStructuredPractice?.title }}</h2>
      </div>

      <!-- Target Text Container -->
      <ion-card class="target-text-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="document-text" color="primary"></ion-icon>
            Target Text
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p class="target-text">{{ currentStructuredPractice?.targetText }}</p>
          
          <div class="listen-controls">
            <ion-button 
              *ngIf="!isListeningToText"
              fill="outline" 
              color="secondary"
              (click)="listenToTargetText()">
              <ion-icon name="volume-high" slot="start"></ion-icon>
              LISTEN
            </ion-button>
            
            <ion-button 
              *ngIf="isListeningToText"
              fill="solid" 
              color="medium"
              (click)="stopListening()">
              <ion-icon name="stop" slot="start"></ion-icon>
              Stop Listening
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Your Speech Container -->
      <ion-card class="speech-input-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="mic" color="danger"></ion-icon>
            Your Speech
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="speech-display">
            <!-- Show placeholder only when no recording and no text -->
            <p *ngIf="!userSpeechText && !isRecording" class="placeholder-text">
              Your speech will appear here when you start recording...
            </p>
            
            <!-- Show listening indicator while recording but before text appears -->
            <p *ngIf="isRecording && !userSpeechText" class="recording-text">
              Listening... Speak now!
            </p>
            
            <!-- Show actual speech text when it exists -->
            <p *ngIf="userSpeechText" class="user-speech">
              {{ userSpeechText }}
            </p>
          </div>
          
          <div class="recording-controls">
            <ion-button 
              *ngIf="!isRecording"
              expand="block" 
              fill="solid" 
              color="danger"
              size="large"
              (click)="startStructuredRecording()">
              <ion-icon name="mic" slot="start"></ion-icon>
              START RECORDING
            </ion-button>
            
            <ion-button 
              *ngIf="isRecording"
              expand="block" 
              fill="solid" 
              color="medium"
              size="large"
              (click)="stopStructuredRecording()">
              <ion-icon name="stop" slot="start"></ion-icon>
              STOP RECORDING
            </ion-button>
            
            <ion-button 
              *ngIf="userSpeechText && !isRecording"
              fill="outline" 
              color="medium"
              (click)="clearSpeech()">
              <ion-icon name="refresh" slot="start"></ion-icon>
              Clear & Retry
            </ion-button>
            
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Tips Card -->
      <ion-card class="tips-card" *ngIf="currentStructuredPractice?.tips">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="bulb" color="warning"></ion-icon>
            Tips for {{ currentStructuredPractice?.title }}
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ul>
            <li *ngFor="let tip of currentStructuredPractice?.tips">{{ tip }}</li>
          </ul>
        </ion-card-content>
      </ion-card>

      <!-- Feedback Button -->
      <div class="feedback-section" *ngIf="userSpeechText && userSpeechText.trim() !== '' && !isRecording">
        <ion-button 
          expand="block" 
          fill="solid" 
          color="success"
          size="large"
          (click)="showDetailedFeedback()">
          <ion-icon name="analytics" slot="start"></ion-icon>
          FEEDBACK
        </ion-button>
      </div>

      <!-- Practice Controls -->
      <div class="practice-controls">
        <ion-button 
          fill="outline" 
          color="medium"
          (click)="stopStructuredPractice()">
          <ion-icon name="close" slot="start"></ion-icon>
          End Session
        </ion-button>
        
        <ion-button 
          *ngIf="showFeedback"
          fill="solid" 
          color="primary"
          (click)="startStructuredPractice()">
          <ion-icon name="refresh" slot="start"></ion-icon>
          Try Again
        </ion-button>
      </div>

    </div>

  </div>
</ion-content>